var data = [{"meta":{"0":"606","1":"662","2":"571","3":"657","4":"611","5":"605","6":"536","7":"661","8":"637","9":"627","10":"603","11":"643","12":"588","13":"588","14":"675","15":"600","16":"635","17":"619","18":"675","19":"701","20":"752","21":"720","22":"783","23":"782","24":"773","age_groups":"All Ages"},"restaurantId":0},{"meta":{"0":"16","1":"17","2":"15","3":"21","4":"21","5":"33","6":"16","7":"21","8":"25","9":"22","10":"28","11":"29","12":"24","13":"24","14":"26","15":"17","16":"25","17":"31","18":"31","19":"26","20":"23","21":"30","22":"41","23":"35","24":"43","age_groups":"90+"},"restaurantId":1},{"meta":{"0":"47","1":"47","2":"42","3":"56","4":"52","5":"54","6":"50","7":"48","8":"60","9":"45","10":"51","11":"62","12":"48","13":"40","14":"41","15":"48","16":"51","17":"54","18":"54","19":"76","20":"68","21":"65","22":"62","23":"74","24":"73","age_groups":"85-89"},"restaurantId":2},{"meta":{"0":"88","1":"85","2":"63","3":"88","4":"79","5":"92","6":"49","7":"90","8":"93","9":"78","10":"55","11":"80","12":"87","13":"75","14":"94","15":"91","16":"68","17":"78","18":"100","19":"111","20":"111","21":"124","22":"113","23":"112","24":"108","age_groups":"80-84"},"restaurantId":3},{"meta":{"0":"101","1":"120","2":"97","3":"119","4":"105","5":"88","6":"80","7":"122","8":"107","9":"104","10":"118","11":"128","12":"92","13":"95","14":"119","15":"105","16":"117","17":"105","18":"105","19":"104","20":"130","21":"117","22":"125","23":"130","24":"118","age_groups":"75-79"},"restaurantId":4},{"meta":{"0":"95","1":"106","2":"95","3":"114","4":"124","5":"106","6":"102","7":"98","8":"100","9":"114","10":"84","11":"103","12":"81","13":"96","14":"128","15":"90","16":"121","17":"101","18":"103","19":"102","20":"124","21":"116","22":"130","23":"138","24":"135","age_groups":"70-74"},"restaurantId":5},{"meta":{"0":"89","1":"104","2":"87","3":"89","4":"77","5":"86","6":"82","7":"91","8":"96","9":"89","10":"105","11":"71","12":"98","13":"83","14":"88","15":"87","16":"77","17":"82","18":"103","19":"90","20":"104","21":"100","22":"98","23":"116","24":"117","age_groups":"65-69"},"restaurantId":6},{"meta":{"0":"72","1":"79","2":"75","3":"77","4":"69","5":"71","6":"57","7":"70","8":"73","9":"66","10":"65","11":"64","12":"60","13":"64","14":"76","15":"72","16":"67","17":"61","18":"71","19":"80","20":"78","21":"63","22":"91","23":"74","24":"79","age_groups":"60-64"},"restaurantId":7},{"meta":{"0":"47","1":"47","2":"41","3":"37","4":"39","5":"34","6":"43","7":"60","8":"39","9":"42","10":"45","11":"57","12":"42","13":"49","14":"46","15":"45","16":"53","17":"48","18":"50","19":"53","20":"57","21":"47","22":"49","23":"49","24":"43","age_groups":"55-59"},"restaurantId":8},{"meta":{"0":"31","1":"30","2":"19","3":"29","4":"22","5":"22","6":"35","7":"26","8":"21","9":"33","10":"27","11":"26","12":"30","13":"27","14":"26","15":"25","16":"28","17":"29","18":"22","19":"28","20":"32","21":"29","22":"43","23":"34","24":"37","age_groups":"50-54"},"restaurantId":9},{"meta":{"0":"11","1":"14","2":"17","3":"17","4":"14","5":"11","6":"11","7":"20","8":"15","9":"20","10":"8","11":"9","12":"12","13":"13","14":"22","15":"11","16":"15","17":"18","18":"17","19":"17","20":"16","21":"13","22":"11","23":"7","24":"13","age_groups":"45-49"},"restaurantId":10},{"meta":{"0":"8","1":"7","2":"11","3":"5","4":"7","5":"6","6":"4","7":"9","8":"4","9":"5","10":"8","11":"10","12":"12","13":"7","14":"4","15":"3","16":"7","17":"8","18":"10","19":"8","20":"5","21":"12","22":"11","23":"8","24":"2","age_groups":"40-44"},"restaurantId":11},{"meta":{"0":"3","1":"2","2":"2","3":"3","4":"0","5":"1","6":"3","7":"4","8":"1","9":"2","10":"0","11":"1","12":"3","13":"3","14":"2","15":"2","16":"3","17":"2","18":"5","19":"4","20":"2","21":"3","22":"6","23":"3","24":"2","age_groups":"35-39"},"restaurantId":12},{"meta":{"0":"0","1":"1","2":"1","3":"1","4":"1","5":"1","6":"3","7":"0","8":"0","9":"4","10":"1","11":"2","12":"0","13":"7","14":"2","15":"2","16":"3","17":"1","18":"1","19":"1","20":"0","21":"0","22":"0","23":"2","24":"2","age_groups":"30-34"},"restaurantId":13},{"meta":{"0":"0","1":"1","2":"0","3":"0","4":"1","5":"0","6":"0","7":"2","8":"0","9":"1","10":"0","11":"1","12":"0","13":"0","14":"1","15":"0","16":"0","17":"1","18":"0","19":"1","20":"0","21":"1","22":"0","23":"0","24":"1","age_groups":"25-29"},"restaurantId":14},{"meta":{"0":"1","1":"1","2":"0","3":"1","4":"0","5":"0","6":"0","7":"1","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"2","21":"0","22":"3","23":"0","24":"0","age_groups":"20-24"},"restaurantId":15},{"meta":{"0":"1","1":"0","2":"0","3":"0","4":"0","5":"0","6":"0","7":"0","8":"1","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","age_groups":"15-19"},"restaurantId":16},{"meta":{"0":"0","1":"0","2":"0","3":"0","4":"0","5":"0","6":"1","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","age_groups":"10-15"},"restaurantId":17},{"meta":{"0":"0","1":"0","2":"0","3":"0","4":"0","5":"0","6":"0","7":"0","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","age_groups":"5-10"},"restaurantId":18},{"meta":{"0":"0","1":"0","2":"0","3":"0","4":"0","5":"0","6":"0","7":"1","8":"0","9":"0","10":"0","11":"0","12":"0","13":"0","14":"0","15":"0","16":"0","17":"0","18":"0","19":"0","20":"0","21":"0","22":"0","23":"0","24":"0","age_groups":"0-5"},"restaurantId":19}];
var tableHead = ['Year','1989','1990','1991','1992','1993','1994','1995','1996','1997','1998','1999','2000','2001','2002','2003','2004','2005','2006','2007','2008','2009','2010','2011','2012','2013'];

function drawChart(restaurantId) {
  var parsedData = [];
  parsedData.push(tableHead);

  var meta = data[restaurantId].meta;
  parsedData.push([restaurantId]);
  for (var i = 0; i < 25; ++i) {
    parsedData[1].push(parseInt(meta['' + i]));
  }
  console.log(parsedData);

  var tableData = google.visualization.arrayToDataTable(parsedData);
  var options = {
    title: 'Some Restaurant data',
    curveType: 'function',
    legend: { position: 'bottom' }
  };
  var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
  chart.draw(tableData, options);
}

var hash = window.location.hash.substring(1);
var hashSplit = hash.split('&');
var params = {};

for (var i = 0; i < hashSplit.length; ++i) {
  var paramSplit = hashSplit[i].split('=');
  var paramKey = paramSplit[0];
  var paramValue = paramSplit[1];
  
  params[paramKey] = paramValue;
  $('#' + paramKey + '_value').val(paramValue);
}

var loc = 'Glasgow';
var limit = 20;
var sortby = 0;
var radius_filter = 1000;

var map = new google.maps.Map(document.getElementById('map'), {
  center: { lat: 55.86, lng: -4.24 },
  zoom: 8
});

var rq = JSON.parse(sessionStorage.getItem('kwds'));
get_data(rq.terms, rq.co, rq.loc);

//terms=keyword to search for,location=city,street,post code etc,limit=how many results you want,
//sortby=0=Best matched (default), 1=Distance, 2=Highest Rated.,radius_filter=radius in which to look for restaurants
function get_data(terms, coordinates) {
  terms = terms.toLowerCase();
  terms = terms.replace(/ /g,'-').replace(/[^\w-]+/g,'');

  var auth = {               
    consumerKey: "dkfap0uAB8Sr7XL7VUi3qQ",
    consumerSecret: "lj03Y4N8AFOv_zBfGBz5vLeoaKU",
    accessToken: "8jGK6Ta_wYKb9LPvYgoiAjUjaYC13M86",
    accessTokenSecret: "IvU2j7kmlp2TO-1SSsPhDHe6NcE",
    serviceProvider: { signatureMethod: "HMAC-SHA1" }
  };          

  var accessor = {
    consumerSecret: auth.consumerSecret,
    tokenSecret: auth.accessTokenSecret
  };

  var parameters = [];
  parameters.push(['term', terms]);
  parameters.push(['location', loc]);
  if (coordinates != null) parameters.push(['cll',coordinates]);
  parameters.push(['limit', limit]);
  parameters.push(['sort', sortby]);
  parameters.push(['radius_filter', radius_filter]);
  parameters.push(['callback', 'cb']);
  parameters.push(['oauth_consumer_key', auth.consumerKey]);
  parameters.push(['oauth_consumer_secret', auth.consumerSecret]);
  parameters.push(['oauth_token', auth.accessToken]);
  parameters.push(['oauth_signature_method', 'HMAC-SHA1']);

  var msg = {
    action: 'http://api.yelp.com/v2/search',
    method: 'GET',
    parameters: parameters
  };

  OAuth.setTimestampAndNonce(msg);
  OAuth.SignatureMethod.sign(msg, accessor);

  var parameterMap = OAuth.getParameterMap(msg.parameters);
  $.ajax({
    url: msg.action,
    data: parameterMap,
    dataType: 'jsonp',
    async: false,
    jsonpCallback: 'cb',                
    success: function(data) {
      populate(data.businesses);
      //workdata=data.businesses;       
      //call map  population function here function(data.businesses);                    
    }
  });            
}

function populate(restaurantData) {
  console.log(restaurantData);
    
  var infowindows = [];
  var markers = [];

  for (var i = 0; i < restaurantData.length; ++i) {
    var venueData = restaurantData[i];
    var restaurantName = venueData.name;
    var number = venueData.phone;
    var categories = venueData.categories;//array of object each of them with a name
    var url = venueData.url;

    var vLocation = venueData.location;
    var location = {
      address: vLocation.address,
      cc: vLocation.cc,
      city: vLocation.city,
      country: vLocation.country_code,
      distance: vLocation.distance,
      formattedAddress: vLocation.display_address
    };

    var contentString = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">' + restaurantName +'</h1>' +
                '<div id="bodyContent">'+
                '<p><b>Contact:</b>' + number +
                '<b>Address:</b>'+ location.address + 
                location.cc +
                location.city +
                location.country +
                '<b>Distance from current location:</b>' + location.distance
                '<b>Web page:</b>'+ url +'</p>'+
        '<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">'+
        'https://en.wikipedia.org/w/index.php?title=Uluru</a> '+
        '(last visited June 22, 2009).</p>'+
        '</div>'+
        '</div>';

    var infoWindow = new google.maps.InfoWindow({content: contentString});
    infowindows.push(infoWindow);
    
    var marker = new google.maps.Marker({
      position: {
        lat: venueData.location.coordinate.latitude,
        lng: venueData.location.coordinate.longitude
      },
      map: map,
      title: restaurantName
    });
    markers.push(marker); 
    
    //TODO: alex - ask Nasko not sure why it is not working
    markers[i].addListener('click', function(i) {
      drawChart(i);
      infowindows[i].open(map, markers[i]);
      for (var j = 0; j < restaurantData.length; j++) {
        if (i != j) infowindows[j].close();
      }
    }.bind(this, i));
  }
}
